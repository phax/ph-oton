(function(k){var b=function(){return{isMsie:function(){return/(msie|trident)/i.test(navigator.userAgent)?navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2]:!1},isBlankString:function(a){return!a||/^\s*$/.test(a)},escapeRegExChars:function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},isString:function(a){return"string"===typeof a},isNumber:function(a){return"number"===typeof a},isArray:k.isArray,isFunction:k.isFunction,isObject:k.isPlainObject,isUndefined:function(a){return"undefined"===
typeof a},toStr:function(a){return b.isUndefined(a)||null===a?"":a+""},bind:k.proxy,each:function(a,b){k.each(a,function(a,g){return b(g,a)})},map:k.map,filter:k.grep,every:function(a,b){var c=!0;if(!a)return c;k.each(a,function(g,e){if(!(c=b.call(null,e,g,a)))return!1});return!!c},some:function(a,b){var c=!1;if(!a)return c;k.each(a,function(g,e){if(c=b.call(null,e,g,a))return!1});return!!c},mixin:k.extend,getUniqueId:function(){var a=0;return function(){return a++}}(),templatify:function(a){function b(){return String(a)}
return k.isFunction(a)?a:b},defer:function(a){setTimeout(a,0)},debounce:function(a,b,c){var g,e;return function(){var d=this,h=arguments,l;l=c&&!g;clearTimeout(g);g=setTimeout(function(){g=null;c||(e=a.apply(d,h))},b);l&&(e=a.apply(d,h));return e}},throttle:function(a,b){var c,g,e,d,h,l;h=0;l=function(){h=new Date;e=null;d=a.apply(c,g)};return function(){var m=new Date,p=b-(m-h);c=this;g=arguments;0>=p?(clearTimeout(e),e=null,h=m,d=a.apply(c,g)):e||(e=setTimeout(l,p));return d}},noop:function(){}}}(),
v=function(){function a(a){return(a=b.toStr(a))?a.split(/\s+/):[]}function f(a){return(a=b.toStr(a))?a.split(/\W+/):[]}function c(a){return function(){var e=[].slice.call(arguments,0);return function(d){var h=[];b.each(e,function(e){h=h.concat(a(b.toStr(d[e])))});return h}}}return{nonword:f,whitespace:a,obj:{nonword:c(f),whitespace:c(a)}}}(),r=function(){function a(a){this.maxSize=b.isNumber(a)?a:100;this.reset();0>=this.maxSize&&(this.set=this.get=k.noop)}function f(){this.head=this.tail=null}function c(a,
e){this.key=a;this.val=e;this.prev=this.next=null}b.mixin(a.prototype,{set:function(a,e){var d=this.list.tail;this.size>=this.maxSize&&(this.list.remove(d),delete this.hash[d.key]);(d=this.hash[a])?(d.val=e,this.list.moveToFront(d)):(d=new c(a,e),this.list.add(d),this.hash[a]=d,this.size++)},get:function(a){if(a=this.hash[a])return this.list.moveToFront(a),a.val},reset:function(){this.size=0;this.hash={};this.list=new f}});b.mixin(f.prototype,{add:function(a){this.head&&(a.next=this.head,this.head.prev=
a);this.head=a;this.tail=this.tail||a},remove:function(a){a.prev?a.prev.next=a.next:this.head=a.next;a.next?a.next.prev=a.prev:this.tail=a.prev},moveToFront:function(a){this.remove(a);this.add(a)}});return a}(),w=function(){function a(a){this.prefix=["__",a,"__"].join("");this.ttlKey="__ttl__";this.keyMatcher=new RegExp("^"+b.escapeRegExChars(this.prefix))}function f(a){return JSON.stringify(b.isUndefined(a)?null:a)}var c;try{c=window.localStorage,c.setItem("~~~","!"),c.removeItem("~~~")}catch(g){c=
null}b.mixin(a.prototype,c&&window.JSON?{_prefix:function(a){return this.prefix+a},_ttlKey:function(a){return this._prefix(a)+this.ttlKey},get:function(a){this.isExpired(a)&&this.remove(a);a=c.getItem(this._prefix(a));return JSON.parse(a)},set:function(a,d,h){b.isNumber(h)?c.setItem(this._ttlKey(a),f((new Date).getTime()+h)):c.removeItem(this._ttlKey(a));return c.setItem(this._prefix(a),f(d))},remove:function(a){c.removeItem(this._ttlKey(a));c.removeItem(this._prefix(a));return this},clear:function(){var a,
d,h=[],l=c.length;for(a=0;a<l;a++)(d=c.key(a)).match(this.keyMatcher)&&h.push(d.replace(this.keyMatcher,""));for(a=h.length;a--;)this.remove(h[a]);return this},isExpired:function(a){a=c.getItem(this._ttlKey(a));a=JSON.parse(a);return b.isNumber(a)&&(new Date).getTime()>a?!0:!1}}:{get:b.noop,set:b.noop,remove:b.noop,clear:b.noop,isExpired:b.noop});return a}(),u=function(){function a(a){a=a||{};this.cancelled=!1;this.lastUrl=null;this._send=a.transport?f(a.transport):k.ajax;this._get=a.rateLimiter?
a.rateLimiter(this._get):this._get;this._cache=!1===a.cache?new r(0):d}function f(a){return function(d,e){var c=k.Deferred();a(d,e,function(a){b.defer(function(){c.resolve(a)})},function(a){b.defer(function(){c.reject(a)})});return c}}var c=0,g={},e=6,d=new r(10);a.setMaxPendingRequests=function(a){e=a};a.resetCache=function(){d.reset()};b.mixin(a.prototype,{_get:function(a,d,m){function b(d){m&&m(null,d);n._cache.set(a,d)}function f(){m&&m(!0)}function k(){c--;delete g[a];n.onDeckRequestArgs&&(n._get.apply(n,
n.onDeckRequestArgs),n.onDeckRequestArgs=null)}var n=this,t;this.cancelled||a!==this.lastUrl||((t=g[a])?t.done(b).fail(f):c<e?(c++,g[a]=this._send(a,d).done(b).fail(f).always(k)):this.onDeckRequestArgs=[].slice.call(arguments,0))},get:function(a,d,e){var c;b.isFunction(d)&&(e=d,d={});this.cancelled=!1;this.lastUrl=a;(c=this._cache.get(a))?b.defer(function(){e&&e(null,c)}):this._get(a,d,e);return!!c},cancel:function(){this.cancelled=!0}});return a}(),x=function(){function a(a){a=a||{};a.datumTokenizer&&
a.queryTokenizer||k.error("datumTokenizer and queryTokenizer are both required");this.datumTokenizer=a.datumTokenizer;this.queryTokenizer=a.queryTokenizer;this.reset()}function f(a){a=b.filter(a,function(a){return!!a});return a=b.map(a,function(a){return a.toLowerCase()})}function c(a){for(var d={},b=[],l=0,c=a.length;l<c;l++)d[a[l]]||(d[a[l]]=!0,b.push(a[l]));return b}function g(a,d){function b(a,d){return a-d}var c=0,m=0,p=[];a=a.sort(b);d=d.sort(b);for(var f=a.length,g=d.length;c<f&&m<g;)a[c]<
d[m]?c++:(a[c]>d[m]||(p.push(a[c]),c++),m++);return p}b.mixin(a.prototype,{bootstrap:function(a){this.datums=a.datums;this.trie=a.trie},add:function(a){var d=this;a=b.isArray(a)?a:[a];b.each(a,function(a){var c;c=d.datums.push(a)-1;a=f(d.datumTokenizer(a));b.each(a,function(a){var b,h;b=d.trie;for(a=a.split("");h=a.shift();)b=b.children[h]||(b.children[h]={ids:[],children:{}}),b.ids.push(c)})})},get:function(a){var d=this,h;a=f(this.queryTokenizer(a));b.each(a,function(a){var b,c;if(h&&0===h.length)return!1;
b=d.trie;for(a=a.split("");b&&(c=a.shift());)b=b.children[c];if(b&&0===a.length)b=b.ids.slice(0),h=h?g(h,b):b;else return h=[],!1});return h?b.map(c(h),function(a){return d.datums[a]}):[]},reset:function(){this.datums=[];this.trie={ids:[],children:{}}},serialize:function(){return{datums:this.datums,trie:this.trie}}});return a}(),q=function(){return{local:function(a){return a.local||null},prefetch:function(a){var f;f={url:null,thumbprint:"",ttl:864E5,filter:null,ajax:{}};if(a=a.prefetch||null)a=b.isString(a)?
{url:a}:a,a=b.mixin(f,a),a.thumbprint="0.10.5"+a.thumbprint,a.ajax.type=a.ajax.type||"GET",a.ajax.dataType=a.ajax.dataType||"json",!a.url&&k.error("prefetch requires url to be set");return a},remote:function(a){function f(a){return function(d){return b.debounce(d,a)}}function c(a){return function(d){return b.throttle(d,a)}}var g;g={url:null,cache:!0,wildcard:"%QUERY",replace:null,rateLimitBy:"debounce",rateLimitWait:300,send:null,filter:null,ajax:{}};if(a=a.remote||null)a=b.isString(a)?{url:a}:a,
a=b.mixin(g,a),a.rateLimiter=/^throttle$/i.test(a.rateLimitBy)?c(a.rateLimitWait):f(a.rateLimitWait),a.ajax.type=a.ajax.type||"GET",a.ajax.dataType=a.ajax.dataType||"json",delete a.rateLimitBy,delete a.rateLimitWait,!a.url&&k.error("remote requires url to be set");return a}}}();(function(a){function f(a){a&&(a.local||a.prefetch||a.remote)||k.error("one of local, prefetch, or remote is required");this.limit=a.limit||5;this.sorter=c(a.sorter);this.dupDetector=a.dupDetector||g;this.local=q.local(a);
this.prefetch=q.prefetch(a);this.remote=q.remote(a);this.cacheKey=this.prefetch?this.prefetch.cacheKey||this.prefetch.url:null;this.index=new x({datumTokenizer:a.datumTokenizer,queryTokenizer:a.queryTokenizer});this.storage=this.cacheKey?new w(this.cacheKey):null}function c(a){function c(b){return b.sort(a)}function l(a){return a}return b.isFunction(a)?c:l}function g(){return!1}var e;e=a.Bloodhound;a.Bloodhound=f;f.noConflict=function(){a.Bloodhound=e;return f};f.tokenizers=v;b.mixin(f.prototype,
{_loadPrefetch:function(a){function b(h){c.clear();c.add(a.filter?a.filter(h):h);c._saveToStorage(c.index.serialize(),a.thumbprint,a.ttl)}var c=this,e;(e=this._readFromStorage(a.thumbprint))?(this.index.bootstrap(e),e=k.Deferred().resolve()):e=k.ajax(a.url,a.ajax).done(b);return e},_getFromRemote:function(a,b){function c(a,d){a?b([]):b(e.remote.filter?e.remote.filter(d):d)}var e=this,f;if(this.transport)return a=a||"",f=encodeURIComponent(a),f=this.remote.replace?this.remote.replace(this.remote.url,
a):this.remote.url.replace(this.remote.wildcard,f),this.transport.get(f,this.remote.ajax,c)},_cancelLastRemoteRequest:function(){this.transport&&this.transport.cancel()},_saveToStorage:function(a,b,c){this.storage&&(this.storage.set("data",a,c),this.storage.set("protocol",location.protocol,c),this.storage.set("thumbprint",b,c))},_readFromStorage:function(a){var b,c,e;this.storage&&(b=this.storage.get("data"),c=this.storage.get("protocol"),e=this.storage.get("thumbprint"));a=e!==a||c!==location.protocol;
return b&&!a?b:null},_initialize:function(){function a(){c.add(b.isFunction(e)?e():e)}var c=this,e=this.local,f;f=this.prefetch?this._loadPrefetch(this.prefetch):k.Deferred().resolve();e&&f.done(a);this.transport=this.remote?new u(this.remote):null;return this.initPromise=f.promise()},initialize:function(a){return!this.initPromise||a?this._initialize():this.initPromise},add:function(a){this.index.add(a)},get:function(a,c){function e(a){var d=g.slice(0);b.each(a,function(a){!b.some(d,function(b){return f.dupDetector(a,
b)})&&d.push(a);return d.length<f.limit});c&&c(f.sorter(d))}var f=this,g=[],k=!1,g=this.index.get(a),g=this.sorter(g).slice(0,this.limit);g.length<this.limit?k=this._getFromRemote(a,e):this._cancelLastRemoteRequest();k||(0<g.length||!this.transport)&&c&&c(g)},clear:function(){this.index.reset()},clearPrefetchCache:function(){this.storage&&this.storage.clear()},clearRemoteCache:function(){this.transport&&u.resetCache()},ttAdapter:function(){return b.bind(this.get,this)}});return f})(this)})(window.jQuery);
